<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Age-depth sediment accumulation modelling for sediment cores. hamstr implements a Bacon-like sediment accumulation or age-depth model, similar to that of Blaauw and Christen (2011) &lt;doi:10.1214/ba/1339616472&gt;, but with hierarchically structured multi-resolution discrete sediment sections. The Bayesian model is implemented in the Stan probabilistic programming language &lt;https://mc-stan.org/&gt;.">
<title>Hierarchical Accumulation Modelling with Stan and R • hamstr</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Hierarchical Accumulation Modelling with Stan and R">
<meta property="og:description" content="Age-depth sediment accumulation modelling for sediment cores. hamstr implements a Bacon-like sediment accumulation or age-depth model, similar to that of Blaauw and Christen (2011) &lt;doi:10.1214/ba/1339616472&gt;, but with hierarchically structured multi-resolution discrete sediment sections. The Bayesian model is implemented in the Stan probabilistic programming language &lt;https://mc-stan.org/&gt;.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">hamstr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="hamstr-hierarchical-accumulation-modelling-with-stan-and-r-">hamstr: Hierarchical Accumulation Modelling with Stan and R <img src="reference/figures/hex-hamstr-offset.png" align="right" width="120px/"><a class="anchor" aria-label="anchor" href="#hamstr-hierarchical-accumulation-modelling-with-stan-and-r-"></a>
</h1></div>
<!-- badges: start -->

<p><strong>hamstr</strong> implements a <em>Bacon-like</em> (Blaauw and Christen, 2011) sediment accumulation or age-depth model with hierarchically structured multi-resolution sediment sections. The Bayesian model is implemented in the Stan probabilistic programming language (<a href="https://mc-stan.org/" class="external-link uri">https://mc-stan.org/</a>).</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p><strong>hamstr</strong> can be installed directly from Github</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://remotes.r-lib.org" class="external-link">"remotes"</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"earthsystemdiagnostics/hamstr"</span>, args <span class="op">=</span> <span class="st">"--preclean"</span>, build_vignettes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-hamstr">Using <strong>hamstr</strong>
<a class="anchor" aria-label="anchor" href="#using-hamstr"></a>
</h2>
<p>Examples using the example core “MSB2K” from the <a href="https://cran.r-project.org/web/packages/rbacon/index.html" class="external-link">rbacon</a> package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://earthsystemdiagnostics.github.io/hamstr/">hamstr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">20200827</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="converting-radiocarbon-ages-to-calendar-ages">Converting radiocarbon ages to calendar ages.<a class="anchor" aria-label="anchor" href="#converting-radiocarbon-ages-to-calendar-ages"></a>
</h3>
<p>Unlike Bacon, <strong>hamstr</strong> does not do the conversion of radiocarbon dates to calendar ages as part of the model fitting process. This must be done in advance. <strong>hamstr</strong> includes the helper function <code>calibrate_14C_age</code> to do this, which in turn uses the function <code>BchronCalibrate</code> from the <a href="https://cran.r-project.org/web/packages/Bchron/index.html" class="external-link">Bchron</a> package.</p>
<p>Additionally, unlike Bacon, <strong>hamstr</strong> approximates the complex empirical calendar age PDF that results from calibration into a single point estimate and 1-sigma uncertainty. This is a necessary compromise in order to be able to use the power of the Stan platform. Viewed in context with the many other uncertainties in radiocarbon dates and the resulting age-models this will not usually be a major issue.</p>
<p>The function <code>calibrate_14C_age</code> will append columns to a data.frame with the calendar ages and 1-sigma uncertainties.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MSB2K_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/calibrate_14C_age.html">calibrate_14C_age</a></span><span class="op">(</span><span class="va">MSB2K</span>, age.14C <span class="op">=</span> <span class="st">"age"</span>, age.14C.se <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></span></code></pre></div>
<p>The approximated calendar age PDFs can be compared with the empirical PDFs with the function <code>compare_14C_PDF</code></p>
<p>A sample of six dates are plotted here for the IntCal20 and Marine20 calibrations. This approximation is much less of an issue for marine radiocarbon dates, as the cosmogenic radiocarbon signal has been smoothed by mixing in the ocean.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">40</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">40</span><span class="op">/</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="fu"><a href="reference/compare_14C_PDF.html">compare_14C_PDF</a></span><span class="op">(</span><span class="va">MSB2K</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">MSB2K</span><span class="op">$</span><span class="va">error</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, cal_curve <span class="op">=</span> <span class="st">"intcal20"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Intcal20"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-t_approx_intcal-1.svg" width="100%"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/compare_14C_PDF.html">compare_14C_PDF</a></span><span class="op">(</span><span class="va">MSB2K</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">MSB2K</span><span class="op">$</span><span class="va">error</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, cal_curve <span class="op">=</span> <span class="st">"marine20"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Marine20"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-t_approx_marine-1.svg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="fitting-age-models-with-hamstr">Fitting age-models with <strong>hamstr</strong>
<a class="anchor" aria-label="anchor" href="#fitting-age-models-with-hamstr"></a>
</h3>
<p>Age-depth (sediment accumulation) models are fit with the function <code>hamstr</code>. Vectors of depth, observed age and age uncertainty are passed as arguments to <code><a href="reference/hamstr.html">hamstr()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hamstr_fit_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hamstr.html">hamstr</a></span><span class="op">(</span>depth <span class="op">=</span> <span class="va">MSB2K_cal</span><span class="op">$</span><span class="va">depth</span>,</span>
<span>                       obs_age <span class="op">=</span> <span class="va">MSB2K_cal</span><span class="op">$</span><span class="va">age.14C.cal</span>,</span>
<span>                       obs_err <span class="op">=</span> <span class="va">MSB2K_cal</span><span class="op">$</span><span class="va">age.14C.cal.se</span>, </span>
<span>                       <span class="co"># the seed argument for the sampler is set here so that</span></span>
<span>                       <span class="co"># this example always returns the same numerical result</span></span>
<span>                       <span class="co"># you should not normally do this </span></span>
<span>                       stan_sampler_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The default plotting method shows the fitted age models together with some diagnostic plots: a traceplot of the log-posterior to assess convergence of the overall model; a plot of accumulation rate against depth at each hierarchical level; and the prior and posterior of the memory parameter(s). By default the age-models are summarised to show the mean, median, 68% and 95% posterior intervals (equivalent to 1- and 2-sigma uncertainty). The data are shown as points with their 1- and 2-sigma uncertainties. The structure of the sections is shown as tick marks along the top of the age-model plot.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for colour is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for colour, which will replace the existing scale.</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_default-1.svg" width="100%"></p>
<p>A “spaghetti” plot can be created instead of shaded regions. This shows a random sample of iterations from the posterior distribution (realisations of the age-depth model). This can be slow if lots of iterations are plotted, the default is to plot 1000 iterations. Additionally, plotting of the diagnostic plots can be switched off.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, summarise <span class="op">=</span> <span class="cn">FALSE</span>, plot_diagnostics <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_realisations-1.png" width="100%"></p>
<div class="section level4">
<h4 id="mean-accumulation-rate">Mean accumulation rate<a class="anchor" aria-label="anchor" href="#mean-accumulation-rate"></a>
</h4>
<p>There is no need to specify a prior value for the mean accumulation rate (parameter <code>acc.mean</code> in Bacon) as in <strong>hamstr</strong>, this overall mean accumulation rate is a full parameter estimated from the data.</p>
<p>By default, <strong>hamstr</strong> uses robust linear regression (<code><a href="https://rdrr.io/pkg/MASS/man/rlm.html" class="external-link">MASS::rlm</a></code>) to estimate the mean accumulation rate from the data, and then uses this to parametrise a prior distribution for the overall mean accumulation rate. This prior is a half-normal with zero mean and standard deviation equal to 10 times the estimated mean. Although this does introduce a slight element of “double-dipping”, using the data twice (for both the prior and likelihood), the resulting prior is only weakly-informative. The advantage of this approach is that the prior is automatically scaled appropriately regardless of the units of depth or age.</p>
<p>This prior can be checked visually against the posterior. The posterior distribution should be much narrower than the weakly informative prior.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, type <span class="op">=</span> <span class="st">"acc_mean_prior_post"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_acc_mean-1.svg" width="100%"></p>
</div>
<div class="section level4">
<h4 id="other-hyperparameters">Other hyperparameters<a class="anchor" aria-label="anchor" href="#other-hyperparameters"></a>
</h4>
<p><code>acc_shape</code>, the shape of the gamma distributed prior on accumulation rates has a default value of 4 <code>acc_shape = 4</code>. The memory mean <code>mem_mean = 0.5</code> and memory strength <code>mem_strength = 10</code>, are the same as for Bacon &gt;= 2.5.1.</p>
</div>
</div>
<div class="section level3">
<h3 id="setting-the-number-and-hierarchical-structure-of-the-discrete-sections">Setting the number and hierarchical structure of the discrete sections<a class="anchor" aria-label="anchor" href="#setting-the-number-and-hierarchical-structure-of-the-discrete-sections"></a>
</h3>
<p>One of the more critical tuning parameters in the <strong>Bacon</strong> model is the parameter <code>thick</code>, which determines the thickness and number of discrete down-core sediment sections modelled. Finding a good or optimal value for a given core is often critical to getting a good age-depth model. Too few sections and the resulting age-model is very “blocky” and can miss changes in sedimentation rate; however, counter-intuitively, too many very thin sections can also often result in an age-model that “under-fits” the data - a straight line through the age-control points when a lower resolution model shows variation in accumulation rate.</p>
<p>The key structural difference between <strong>Bacon</strong> and <strong>hamstr</strong> models is that with <strong>hamstr</strong> the sediment core is modelled at multiple resolutions simultaneously - removing the need to trade-off smoothness and flexibility. The resolutions have a hierarchical structure whereby coarse resolution “parent” sections act as priors for higher resolution “child” sections.</p>
<p>For <strong>hamstr</strong> version 0.8.0 and onwards, the parameter <code>K_fine</code> controls the number of discrete sections at the highest resolution level, while <code>K_factor</code> controls how much thicker the discrete sections are at each subsequent level. Sufficient levels are modelled so that the coarsest level has just one section - an overall mean accumulation rate.</p>
<p>The structure is hierarchical in the sense that the modelled accumulation rates for the parent sections act as priors for their child sections; specifically, the estimated accumulation rate for a coarse parent section acts as the mean of the gamma prior for its child sections. In turn, the overall mean accumulation rate for the whole core is itself a parameter estimated by the fitting process. The hierarchical structure of increasing resolution allows the model to adapt to low-frequency changes in the accumulation rate, that is changes between “regimes” of high or low accumulation that persist for long periods.</p>
<p>By default, the number of sections at the highest resolution (<code>K_fine</code>) is set so that the sections have approximately unit thickness, i.e. if the depths are in cm, the sections are 1 cm thick. This applies up to a maximum of 900 sections above which the default remains 900 sections and a coarser resolution is used. This can be changed from the default via the parameter <code>K_fine</code>.</p>
<p><code>K_factor</code> is set so that the total number of modelled sections is approximately 1.2 times <code>K_fine</code>, or</p>
<p><code>K_factor</code>^<code>K_factor</code> <span class="math inline">≈</span> <code>K_tot</code> <span class="math inline">≈</span> <code>1.2 * K_fine</code></p>
<p>For a given shape parameter <code>acc_shape</code>, increasing the number of modelled hierarchical levels increases the total variance in the accumulation rates at the highest / finest resolution level. From <strong>hamstr</strong> version 0.5.0 and onwards, the total variance is controlled by modifying the shape parameter according to the number of hierarchical levels.</p>
</div>
<div class="section level3">
<h3 id="getting-the-fitted-age-models">Getting the fitted age models<a class="anchor" aria-label="anchor" href="#getting-the-fitted-age-models"></a>
</h3>
<p>The fitted age models can be obtained with the <code>predict</code> and <code>summary</code> methods. <em>iter</em> is the iteration of the sampler, or “realisation” of the age model.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 396,000 × 3</span></span>
<span><span class="co">#&gt;     iter depth   age</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1     1   1.5 4546.</span></span>
<span><span class="co">#&gt;  2     1   2.5 4553.</span></span>
<span><span class="co">#&gt;  3     1   3.5 4561.</span></span>
<span><span class="co">#&gt;  4     1   4.5 4570.</span></span>
<span><span class="co">#&gt;  5     1   5.5 4579.</span></span>
<span><span class="co">#&gt;  6     1   6.5 4588.</span></span>
<span><span class="co">#&gt;  7     1   7.5 4597.</span></span>
<span><span class="co">#&gt;  8     1   8.5 4609.</span></span>
<span><span class="co">#&gt;  9     1   9.5 4624.</span></span>
<span><span class="co">#&gt; 10     1  10.5 4641.</span></span>
<span><span class="co">#&gt; # ℹ 395,990 more rows</span></span></code></pre></div>
<p><code>summary</code> returns the age model summarised over the realisations.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 99 × 15</span></span>
<span><span class="co">#&gt;    depth   idx par         mean se_mean    sd `2.5%` `15.9%` `25%` `50%` `75%`</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   1.5     1 c_ages[1]  4461.   1.48   65.6  4316.   4398. 4422. 4466. 4505.</span></span>
<span><span class="co">#&gt;  2   2.5     2 c_ages[2]  4477.   1.37   61.4  4343.   4419. 4440. 4482. 4520.</span></span>
<span><span class="co">#&gt;  3   3.5     3 c_ages[3]  4494.   1.26   57.8  4370.   4438. 4459. 4497. 4533.</span></span>
<span><span class="co">#&gt;  4   4.5     4 c_ages[4]  4511.   1.17   54.7  4394.   4459. 4477. 4515. 4548.</span></span>
<span><span class="co">#&gt;  5   5.5     5 c_ages[5]  4528.   1.07   52.1  4416.   4477. 4495. 4531. 4563.</span></span>
<span><span class="co">#&gt;  6   6.5     6 c_ages[6]  4544.   0.980  49.6  4439.   4496. 4514. 4547. 4579.</span></span>
<span><span class="co">#&gt;  7   7.5     7 c_ages[7]  4561.   0.894  47.4  4461.   4514. 4532. 4563. 4593.</span></span>
<span><span class="co">#&gt;  8   8.5     8 c_ages[8]  4578.   0.820  45.8  4484.   4531. 4549. 4579. 4609.</span></span>
<span><span class="co">#&gt;  9   9.5     9 c_ages[9]  4595.   0.760  44.3  4505.   4550. 4567. 4597. 4625.</span></span>
<span><span class="co">#&gt; 10  10.5    10 c_ages[10] 4615.   0.715  42.7  4528.   4572. 4587. 4616. 4643.</span></span>
<span><span class="co">#&gt; # ℹ 89 more rows</span></span>
<span><span class="co">#&gt; # ℹ 4 more variables: `84.1%` &lt;dbl&gt;, `97.5%` &lt;dbl&gt;, n_eff &lt;dbl&gt;, Rhat &lt;dbl&gt;</span></span></code></pre></div>
<p>The hierarchical structure of the sections makes it difficult to specify the exact depth resolution that you want for your resulting age-depth model. The <code>predict</code> method takes an additional argument <code>depth</code> to interpolate to a specific set of depths. The function returns NA for depths that are outside the modelled depths.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age.mods.interp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>These interpolated age models can summarised with the same function as the original fitted objects, but the n_eff and Rhat information is lost.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">age.mods.interp</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 101 × 10</span></span>
<span><span class="co">#&gt;    depth  mean    sd `2.5%` `15.9%` `25%` `50%` `75%` `84.1%` `97.5%`</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1     0  NaN   NA      NA      NA    NA    NA    NA      NA      NA </span></span>
<span><span class="co">#&gt;  2     1  NaN   NA      NA      NA    NA    NA    NA      NA      NA </span></span>
<span><span class="co">#&gt;  3     2 4469.  63.4  4328.   4408. 4432. 4474. 4512.   4531.   4581.</span></span>
<span><span class="co">#&gt;  4     3 4486.  59.5  4355.   4429. 4449. 4490. 4527.   4545.   4591.</span></span>
<span><span class="co">#&gt;  5     4 4503.  56.2  4382.   4449. 4468. 4506. 4541.   4558.   4603.</span></span>
<span><span class="co">#&gt;  6     5 4519.  53.3  4406.   4468. 4486. 4523. 4555.   4571.   4614.</span></span>
<span><span class="co">#&gt;  7     6 4536.  50.8  4428.   4487. 4504. 4539. 4571.   4586.   4627.</span></span>
<span><span class="co">#&gt;  8     7 4553.  48.4  4450.   4505. 4522. 4555. 4586.   4600.   4641.</span></span>
<span><span class="co">#&gt;  9     8 4569.  46.5  4475.   4523. 4540. 4571. 4601.   4615.   4655.</span></span>
<span><span class="co">#&gt; 10     9 4586.  45.0  4496.   4541. 4558. 4588. 4617.   4631.   4669.</span></span>
<span><span class="co">#&gt; # ℹ 91 more rows</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="getting-and-plotting-the-accumulation-rate">Getting and plotting the accumulation rate<a class="anchor" aria-label="anchor" href="#getting-and-plotting-the-accumulation-rate"></a>
</h3>
<p>The down-core accumulation rates are returned and plotted in both depth-per-time, and time-per-depth units. If the input data are in years and cm then the units will be cm/kyr and yrs/cm respectively. Note that the acc_mean parameter in both <strong>hamstr</strong> and Bacon is parametrised in terms of time per depth.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, type <span class="op">=</span> <span class="st">"acc_rates"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(idx)`</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(depth)`</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_acc_rates-1.svg" width="100%"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, type <span class="op">=</span> <span class="st">"acc_rates"</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Joining with `by = join_by(idx)`</span></span>
<span><span class="co">#&gt; # A tibble: 196 × 15</span></span>
<span><span class="co">#&gt;    depth c_depth_top c_depth_bottom acc_rate_unit   idx   tau  mean    sd `2.5%`</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt;       &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   1.5         1.5            2.5 depth_per_ti…     1     0  75.7  40.6   28.3</span></span>
<span><span class="co">#&gt;  2   2.5         2.5            3.5 depth_per_ti…     2     0  72.6  36.1   29.1</span></span>
<span><span class="co">#&gt;  3   3.5         3.5            4.5 depth_per_ti…     3     0  71.4  34.1   28.9</span></span>
<span><span class="co">#&gt;  4   4.5         4.5            5.5 depth_per_ti…     4     0  69.2  29.0   31.4</span></span>
<span><span class="co">#&gt;  5   5.5         5.5            6.5 depth_per_ti…     5     0  68.8  27.3   32.2</span></span>
<span><span class="co">#&gt;  6   6.5         6.5            7.5 depth_per_ti…     6     0  69.4  28.3   32.4</span></span>
<span><span class="co">#&gt;  7   7.5         7.5            8.5 depth_per_ti…     7     0  69.7  29.2   31.6</span></span>
<span><span class="co">#&gt;  8   8.5         8.5            9.5 depth_per_ti…     8     0  62.3  20.5   32.6</span></span>
<span><span class="co">#&gt;  9   9.5         9.5           10.5 depth_per_ti…     9     0  55.8  16.5   31.0</span></span>
<span><span class="co">#&gt; 10  10.5        10.5           11.5 depth_per_ti…    10     0  53.8  16.1   29.2</span></span>
<span><span class="co">#&gt; # ℹ 186 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: `15.9%` &lt;dbl&gt;, `25%` &lt;dbl&gt;, `50%` &lt;dbl&gt;, `75%` &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   `84.1%` &lt;dbl&gt;, `97.5%` &lt;dbl&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="diagnostic-plots">Diagnostic plots<a class="anchor" aria-label="anchor" href="#diagnostic-plots"></a>
</h3>
<p>Additional diagnostic plots are available. See ?plot.hamstr_fit for options.</p>
<div class="section level4">
<h4 id="plot-modelled-accumulation-rates-at-each-hierarchical-level">Plot modelled accumulation rates at each hierarchical level<a class="anchor" aria-label="anchor" href="#plot-modelled-accumulation-rates-at-each-hierarchical-level"></a>
</h4>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, type <span class="op">=</span> <span class="st">"hier_acc"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_hier_acc-1.svg" width="100%"></p>
</div>
<div class="section level4">
<h4 id="plot-memory-prior-and-posterior">Plot memory prior and posterior<a class="anchor" aria-label="anchor" href="#plot-memory-prior-and-posterior"></a>
</h4>
<p>As for this example the highest resolution sections are approximately 1 cm thick, there is not much difference between R and w.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span>, type <span class="op">=</span> <span class="st">"mem"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-plot_mem-1.svg" width="100%"></p>
</div>
</div>
<div class="section level3">
<h3 id="other-rstan-functions">Other <code>rstan</code> functions<a class="anchor" aria-label="anchor" href="#other-rstan-functions"></a>
</h3>
<p>Within the hamstr_fit object is an <em>rstan</em> object on which all the standard rstan functions should operate correctly.</p>
<p>For example:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/check_hmc_diagnostics.html" class="external-link">check_divergences</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; 0 of 4000 iterations ended with a divergence.</span></span>
<span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_plot_diagnostics.html" class="external-link">stan_rhat</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="reference/figures/README-stan_diags-1.svg" width="100%"></p>
<p>The first <code>alpha</code> parameter is the overall mean accumulation rate.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">hamstr_fit_1</span><span class="op">$</span><span class="va">fit</span>, par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha[1]"</span><span class="op">)</span>,</span>
<span>                 inc_warmup <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-first_alpha-1.svg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<ul>
<li><p>Blaauw, Maarten, and J. Andrés Christen. 2011. Flexible Paleoclimate Age-Depth Models Using an Autoregressive Gamma Process. Bayesian Analysis 6 (3): 457-74. <a href="doi:10.1214/ba/1339616472" class="uri">doi:10.1214/ba/1339616472</a>.</p></li>
<li><p>Parnell, Andrew. 2016. Bchron: Radiocarbon Dating, Age-Depth Modelling, Relative Sea Level Rate Estimation, and Non-Parametric Phase Modelling. R package version 4.2.6. <a href="https://CRAN.R-project.org/package=Bchron" class="external-link uri">https://CRAN.R-project.org/package=Bchron</a></p></li>
<li><p>Stan Development Team (2020). RStan: the R interface to Stan. R package version 2.21.2. <a href="http://mc-stan.org/" class="external-link uri">http://mc-stan.org/</a>.</p></li>
</ul>
</div>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3" class="external-link">GPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing hamstr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Andrew Dolman <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://codecov.io/gh/EarthSystemDiagnostics/hamstr" class="external-link"><img src="https://codecov.io/gh/EarthSystemDiagnostics/hamstr/branch/dev/graph/badge.svg?token=gFBWomcqwc" alt="codecov"></a></li>
<li><a href="https://github.com/EarthSystemDiagnostics/hamstr/actions/workflows/test-coverage.yaml" class="external-link"><img src="https://github.com/EarthSystemDiagnostics/hamstr/actions/workflows/test-coverage.yaml/badge.svg" alt="test-coverage"></a></li>
<li><a href="https://github.com/EarthSystemDiagnostics/hamstr/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/EarthSystemDiagnostics/hamstr/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Andrew Dolman.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
